generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PRIORITY 2: AGENT PROFILES WITH PERSONALITY
// ============================================================================
model Agent {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  name        String
  phone       String
  email       String?
  headshotUrl String?
  active      Boolean  @default(true)
  
  // Personal social media tokens (OAuth)
  facebookToken     String?   // Personal Facebook access token
  facebookPageId    String?   // Personal Facebook Page ID (if they have one)
  instagramToken    String?   // Personal Instagram access token  
  instagramUserId   String?   // Personal Instagram Business Account ID
  tokenExpires      DateTime? // When tokens expire
  
  // Posting preferences
  defaultPostingMode String   @default("company") // "company", "personal", "both"
  
  // ðŸ†• PRIORITY 2: Agent Personality Preferences
  // These customize how AI generates captions for this agent
  tonePreference    String   @default("professional") // professional, casual, warm, luxury, energetic
  emojiLevel        String   @default("moderate")     // none, minimal, moderate, enthusiastic
  hashtagPack       String?                           // JSON array of preferred hashtags
  platformPriority  String   @default("both")         // instagram, facebook, both
  
  // Agent signature style (e.g., "DM me for a viewing ðŸ“±" vs "Call to schedule ðŸ“ž")
  callToActionStyle String?
  
  posts             Post[]
  contentMemories   ContentMemory[]
}

model BrandingSettings {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  companyName     String   @default("Local Real Estate SA")
  logoUrl         String?
  forSaleGraphic  String?
  primaryColor    String   @default("#f9b32d") // Brand Orange (Pantone 1235 C)
  secondaryColor  String   @default("#003d51") // Brand Dark Teal (Pantone 3035 C)
  accentColor1    String   @default("#ea4b8b") // Brand Pink (Pantone 1915 C)
  accentColor2    String   @default("#5dc2e8") // Brand Cyan (Pantone 0821 C)
  accentColor3    String   @default("#92c679") // Brand Green (Pantone 7487 C)
  tagline         String   @default("MAKE YOUR NEXT MOVE A LOCAL ONE")
}

// ============================================================================
// PRIORITY 1: POST STATE MACHINE
// ============================================================================
// Post States: DRAFT, AI_GENERATED, APPROVED, SCHEDULED, POSTED, FAILED

model Post {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Listing Details
  listingUrl  String
  listingId   String?  // ðŸ†• External listing ID for tracking
  address     String
  price       String?
  bedrooms    String?
  bathrooms   String?
  sqft        String?
  description String?
  propertyType String? // apartment, house, townhouse, etc.
  suburb      String?  // ðŸ†• For location-based learning
  priceRange  String?  // ðŸ†• e.g., "under_1m", "1m_3m", "3m_plus"
  
  // Images
  propertyImages   String  // JSON array of image URLs
  selectedImages   String? // JSON array of selected image URLs for posting
  coverImageUrl    String? // Canva cover image
  heroImageUrl     String? // ðŸ†• Featured/hero image from listing
  
  // AI Generated Content
  captions        String   // JSON array of caption variations
  selectedCaption String?  // Final chosen caption
  hashtags        String?
  
  // Agent Info
  agentId     String?
  agent       Agent?   @relation(fields: [agentId], references: [id])
  agentName   String?
  agentPhone  String?
  agentPhoto  String?
  colorTheme  String?
  
  // ðŸ†• PRIORITY 1: Post State Machine
  status          String @default("DRAFT") // DRAFT, AI_GENERATED, APPROVED, SCHEDULED, POSTED, FAILED
  statusHistory   String?    // JSON: [{status, timestamp, user, note}]
  failureReason   String?    // Why posting failed
  retryCount      Int        @default(0)
  
  // Post Management
  postedTo        String?    // "company", "personal", "both"
  scheduledFor    DateTime?
  postedAt        DateTime?
  metaPostId      String?
  instagramPostId String?
  facebookPostId  String?
  
  // ðŸ†• LONG TERM: A/B Testing
  abTestVariant   String?    // 'A', 'B', or null
  abTestGroup     String?    // Group ID for comparing variants
  
  // ðŸ†• LONG TERM: Engagement Tracking
  engagementStats String?    // JSON: {likes, comments, shares, reach, clicks}
  boosted         Boolean    @default(false)
  boostSpent      Float?     // Ad spend if boosted
  
  // ðŸ†• WhatsApp Approval
  whatsappApprovalSent Boolean  @default(false)
  whatsappApprovedAt   DateTime?
  whatsappApprovedBy   String?
  
  // Metadata
  metadata    String?  // JSON for any additional data
  
  // Relations
  contentMemory ContentMemory?
}

// ============================================================================
// PRIORITY 3: CONTENT MEMORY & LEARNING
// ============================================================================
model ContentMemory {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Link to post
  postId      String   @unique
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  // Link to agent (for agent-specific learning)
  agentId     String?
  agent       Agent?   @relation(fields: [agentId], references: [id])
  
  // Property Context
  listingId   String?  // External listing ID
  suburb      String?
  propertyType String? // apartment, house, townhouse
  priceRange  String?  // Categorized price range
  
  // Performance Data
  engagementScore Float   @default(0) // Calculated metric combining all engagement
  likes           Int     @default(0)
  comments        Int     @default(0)
  shares          Int     @default(0)
  reach           Int?
  clicks          Int?
  inquiries       Int     @default(0) // Manual tracking of actual leads
  
  // Content Analysis
  hookStyle       String? // e.g., "question", "lifestyle", "investment", "urgency"
  captionLength   Int?    // Character count
  emojiCount      Int?
  hashtagCount    Int?
  
  // Learning Insights (updated periodically by AI)
  performanceNote String? // e.g., "Lifestyle hook outperformed for this suburb"
  
  @@index([suburb, priceRange, propertyType])
  @@index([engagementScore])
}

// ============================================================================
// LONG TERM: LEARNING INSIGHTS
// ============================================================================
// Aggregated learning patterns across posts
model InsightPattern {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Pattern Context
  suburb      String   @default("")
  priceRange  String   @default("")
  propertyType String  @default("")
  hookStyle   String   @default("")
  
  // Performance Metrics
  avgEngagementScore  Float
  sampleSize          Int     // How many posts in this pattern
  bestPerformingExample String? // Post ID
  
  // AI Recommendation
  recommendation String // e.g., "For Ballito apartments under R3.5m, use lifestyle + investment hooks"
  confidence     Float  @default(0) // 0-1, based on sample size and consistency
  
  @@unique([suburb, priceRange, propertyType, hookStyle])
  @@index([suburb, priceRange, propertyType])
}

// ============================================================================
// LONG TERM: A/B TEST EXPERIMENTS
// ============================================================================
model ABTest {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  name        String   // e.g., "Emoji-heavy vs Minimal - Ballito"
  description String?
  
  // Test Parameters
  testType    String   // caption_style, hook_type, emoji_level, hashtag_strategy
  variantA    String   // Description or config of variant A
  variantB    String   // Description or config of variant B
  
  // Test Status
  active      Boolean  @default(true)
  startDate   DateTime @default(now())
  endDate     DateTime?
  
  // Results
  winningVariant String? // 'A', 'B', or 'TIE'
  variantAEngagement Float?
  variantBEngagement Float?
  
  conclusion  String?  // Summary of learnings
}
